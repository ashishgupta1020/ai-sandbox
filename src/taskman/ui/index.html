<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Taskman UI</title>
    <link rel="stylesheet" href="/styles.css" />
    <!-- Grid.js for highlights table -->
    <link href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  </head>
  <body>
    <div class="container">
    <h1>Taskman UI</h1>
    <p class="muted">Select a project to view tasks.</p>
    

    <section>
      <h2 class="title-row">
        <span>Projects</span>
        <button id="btn-add" type="button" class="btn btn-icon" title="Add project" aria-label="Add project">
          <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
        </button>
      </h2>
      <div id="projects" class="muted" aria-live="polite">Loading…</div>
      <div class="actions">
        <button id="btn-exit" type="button" class="btn btn-danger">Exit server</button>
      </div>
    </section>

    <section>
      <h2 class="title-row">
        <span>Highlights</span>
      </h2>
      <div id="highlights" class="muted" aria-live="polite">Loading highlights…</div>
    </section>

    <!-- Templates for icons/elements -->
    <template id="tpl-icon-pencil">
      <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 0 0 0-1.42l-2.34-2.34a1.003 1.003 0 0 0-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="currentColor"/>
      </svg>
    </template>

    <script>
      async function api(path, opts = {}) {
        const res = await fetch(path, opts);
        const text = await res.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch (_) {}
        if (!res.ok) {
          const msg = (data && data.error) ? data.error : `Request failed: ${res.status}`;
          throw new Error(msg);
        }
        return data;
      }

      function el(tag, attrs = {}, ...children) {
        const n = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === 'class') n.className = v; else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v); else n.setAttribute(k, v);
        }
        for (const c of children) n.append(c);
        return n;
      }

      async function refreshProjects() {
        try {
          const p = await api('/api/projects');
          const box = document.getElementById('projects');
          if (!p.projects || p.projects.length === 0) {
            box.textContent = 'No projects found.';
          } else {
            const ul = el('ul', { class: 'list' });
            for (const name of p.projects) {
              const li = el('li');
              const row = el('div', { class: 'project-row' });
              const link = el('a', { href: `/project.html?name=${encodeURIComponent(name)}` }, name);
              const editBtn = el('button', { type: 'button', class: 'btn btn-icon btn-icon-sm edit-btn', title: `Rename ${name}`, 'aria-label': `Rename ${name}`, 'data-name': name });
              // Append icon from template to avoid setting innerHTML in script
              const tpl = document.getElementById('tpl-icon-pencil');
              if (tpl && 'content' in tpl) {
                editBtn.appendChild(tpl.content.firstElementChild.cloneNode(true));
              }
              row.append(link, editBtn);
              li.append(row);
              ul.appendChild(li);
            }
            box.replaceChildren(ul);
          }
        } catch (e) {
          document.getElementById('projects').textContent = `Error: ${e.message}`;
        }
      }

      async function refreshHighlights() {
        try {
          const data = await api('/api/highlights');
          const box = document.getElementById('highlights');
          const items = Array.isArray(data.highlights) ? data.highlights : [];
          if (items.length === 0) {
            box.textContent = 'No highlights yet.';
            return;
          }
          // Use Grid.js for consistency with tasks table
          if (!window.gridjs || typeof gridjs.Grid !== 'function') {
            const table = el('table', { class: 'table' });
            const thead = el('thead');
            thead.append(
              el('tr', {},
                el('th', {}, 'Project'),
                el('th', {}, 'Summary'),
                el('th', {}, 'Assignee'),
                el('th', {}, 'Status'),
                el('th', {}, 'Priority')
              )
            );
            const tbody = el('tbody');
            for (const hItem of items) {
              const row = el('tr');
              row.append(
                el('td', {}, hItem.project || ''),
                el('td', {}, hItem.summary || ''),
                el('td', {}, hItem.assignee || ''),
                el('td', {}, hItem.status || ''),
                el('td', {}, hItem.priority || '')
              );
              tbody.append(row);
            }
            table.append(thead, tbody);
            box.replaceChildren(table);
            return;
          }
          const rows = items.map((h) => [
            h.project || '',
            h.summary || '',
            h.assignee || '',
            h.status || '',
            h.priority || ''
          ]);
          const grid = new gridjs.Grid({
            columns: ['Project', 'Summary', 'Assignee', 'Status', 'Priority'],
            data: rows,
            sort: true,
            search: true,
            pagination: { limit: 10 }
          });
          box.replaceChildren();
          grid.render(box);
        } catch (e) {
          document.getElementById('highlights').textContent = `Error: ${e.message}`;
        }
      }

      // Initial load
      (async function init() {
        await Promise.all([refreshProjects(), refreshHighlights()]);
        // Wire up actions
        document.getElementById('btn-add').addEventListener('click', async () => {
          try {
            const name = prompt('Enter new project name:');
            if (!name) return;
            await api('/api/projects/open', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
            await Promise.all([refreshProjects(), refreshHighlights()]);
          } catch (e) {
            alert(e.message);
          }
        });
        // Delegate edit-button clicks to the projects container
        document.getElementById('projects').addEventListener('click', async (e) => {
          const btn = e.target.closest('.edit-btn');
          if (!btn) return;
          e.preventDefault();
          e.stopPropagation();
          const oldName = btn.getAttribute('data-name');
          try {
            const newName = prompt(`Enter new name for project '${oldName}':`, oldName);
            if (!newName || newName === oldName) return;
            await api('/api/projects/edit-name', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ old_name: oldName, new_name: newName }) });
            await Promise.all([refreshProjects(), refreshHighlights()]);
          } catch (err) {
            alert(err.message || String(err));
          }
        });
        document.getElementById('btn-exit').addEventListener('click', async () => {
          try {
            await api('/api/exit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
            alert('Server is shutting down. You may need to close this tab.');
          } catch (e) {
            alert(e.message);
          }
        });
      })();
    </script>
    </div>
  </body>
  </html>
