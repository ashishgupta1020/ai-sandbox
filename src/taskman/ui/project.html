<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Taskman Project</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <a href="/">← Back to projects</a>
    <h1 id="title">Project</h1>
    <p id="status" class="muted">Loading…</p>

    <section>
      <h2>Tasks</h2>
      <div id="tasks" class="muted">Loading tasks…</div>
    </section>

    <script>
      function getParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      async function openProject(name) {
        const res = await fetch('/api/projects/open', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        const text = await res.text();
        try { return JSON.parse(text); } catch (_) { return {}; }
      }

      async function loadTasks(name) {
        const res = await fetch(`/api/projects/${encodeURIComponent(name)}/tasks`);
        const data = await res.json();
        const box = document.getElementById('tasks');
        const tasks = data.tasks || [];
        if (!tasks.length) {
          box.textContent = 'No tasks found.';
          return;
        }
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        const headers = ['Index', 'Summary', 'Assignee', 'Status', 'Priority', 'Remarks'];
        for (const h of headers) {
          const th = document.createElement('th'); th.textContent = h; trh.appendChild(th);
        }
        thead.appendChild(trh);
        const tbody = document.createElement('tbody');
        tasks.forEach((t, i) => {
          const tr = document.createElement('tr');
          const cells = [
            String(i+1),
            t.summary || '',
            t.assignee || '',
            t.status || '',
            t.priority || '',
            t.remarks || ''
          ];
          for (const c of cells) {
            const td = document.createElement('td');
            td.textContent = c;
            tr.appendChild(td);
          }
          tbody.appendChild(tr);
        });
        table.appendChild(thead);
        table.appendChild(tbody);
        box.replaceChildren(table);
      }

      (async function init() {
        const name = getParam('name');
        const title = document.getElementById('title');
        const status = document.getElementById('status');
        if (!name) {
          title.textContent = 'Project (missing name)';
          status.textContent = 'No project specified.';
          return;
        }
        title.textContent = `Project: ${name}`;
        try {
          const result = await openProject(name);
          if (result && result.ok) {
            status.textContent = `Opened '${name}'.`;
          } else {
            status.textContent = 'Failed to open project.';
          }
        } catch (e) {
          status.textContent = `Error: ${e.message}`;
        }
        await loadTasks(name);
      })();
    </script>
  </body>
  </html>
